<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Bin Sensor Monitor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --main-color: #4e73df;
      --danger-color: #e94c3c;
      --gray: #f8f9fc;
      --radius: 8px;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 30px;
      max-width: 900px;
      margin: auto;
      background: var(--gray);
      color: #222;
    }
    .section { background: #fff; padding: 18px 20px; border-radius: var(--radius); box-shadow: 0 1px 4px #ddd; margin-bottom: 24px;}
    h2 { color: var(--main-color); font-size: 1.5em; margin-top: 0; }
    label { font-weight: bold; margin-right: 12px; }
    input, select, button {
      padding: 7px 11px;
      border: 1px solid #cccccc;
      border-radius: var(--radius);
      margin-right: 8px;
      outline: none;
      font-size: 1em;
    }
    button {
      background: var(--main-color);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background .15s;
    }
    button:hover { background: #3452bf; }
    .btn-danger { background: var(--danger-color);}
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 1em;
      border-radius: var(--radius);
      overflow: hidden;
      background: #fff;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
    }
    th { background: #f1f5fa; }
    tr.danger-row { background: #ffe4e1;}
    @media (max-width:700px) {
      table, thead, tbody, th, td, tr { display: block; }
      th, td { padding: 9px 6px;}
      tr { margin-bottom:12px;}
    }
    #alertMsg {
      display:none;
      margin: 15px 0;
      padding: 10px;
      border-radius: var(--radius);
      font-weight: 600;
      text-align: center;
      transition: all .2s;
    }
    .actions { margin-bottom: 16px;}
  </style>
</head>
<body>
  <div class="section">
    <h2>设备管理</h2>
    <label for="newSnInput">新增SN:</label>
    <input id="newSnInput" placeholder="输入新设备SN" style="width:140px"/>
    <button onclick="addDevice()">添加设备</button>
  </div>

  <div class="section">
    <h2>上传数据</h2>
    <input id="snInput" placeholder="SN" style="width:110px"/>
    <input id="distanceInput" type="number" min="0" placeholder="距离(cm)" style="width:90px"/>
    <input id="batteryInput" type="number" min="0" max="100" placeholder="电量(%)" style="width:80px"/>
    <input id="tempInput" type="number" min="-40" max="85" placeholder="温度(°C)" style="width:90px"/>
    <input id="positionInput" placeholder="位置" style="width:70px"/>
    <button onclick="sendData()">手动上传</button>
  </div>

  <div class="section">
    <div class="actions">
      <label for="snSelect">选择设备</label>
      <select id="snSelect" onchange="fetchData()">
        <option value="">请选择SN</option>
      </select>
      <input id="thresholdInput" type="number" min="0" placeholder="距离阈值(cm)" style="width:120px"/>
      <button onclick="setThreshold()">设置阈值</button>
      <button onclick="fetchData()">刷新</button>
      <button onclick="exportCSV()">导出CSV</button>
    </div>
    <div id="alertMsg"></div>
    <div id="dataList"></div>
  </div>

<script>
let threshold = null;
let lastFetchTimer = null;
let isFetching = false;
let latestRows = [];

// 格式化时间为新加坡时区
function formatSgt(dt) {
  return new Date(dt).toLocaleString('zh-CN', { hour12: false, timeZone: 'Asia/Singapore' });
}

// 全局alert，动画与可重复弹出
function showAlert(msg, isDanger = false) {
  const div = document.getElementById('alertMsg');
  div.textContent = msg;
  div.style.display = msg ? 'block' : 'none';
  div.style.backgroundColor = isDanger ? '#e94c3c' : '#4e73df';
  div.style.color = '#fff';
  if (div.alertTimer) clearTimeout(div.alertTimer);
  if (msg) {
    div.style.opacity = '1';
    div.alertTimer = setTimeout(() => {
      div.style.opacity = '0';
      setTimeout(() => { div.style.display = 'none'; }, 500);
    }, 3000);
  }
}

// 设备列表加载，并默认选最新一个
async function loadSnList() {
  try {
    const res = await fetch('/api/all-sns');
    const sns = await res.json();
    const select = document.getElementById('snSelect');
    select.innerHTML = `<option value="">请选择SN</option>`;
    sns.forEach(sn => {
      const op = document.createElement('option'); op.value = sn; op.textContent = sn;
      select.appendChild(op);
    });
    // 默认选第一个实际SN
    if (sns.length) {
      select.value = sns[0];
      fetchData();
    } else {
      document.getElementById('dataList').innerHTML = '<p>无设备</p>';
    }
  } catch (e) {
    showAlert("加载设备列表失败", true);
  }
}

// 防抖fetchData
function debounceFetchData(delay = 350) {
  if (lastFetchTimer) clearTimeout(lastFetchTimer);
  lastFetchTimer = setTimeout(fetchData, delay);
}

// 拉取数据并渲染表格，并警告
async function fetchData() {
  const sn = document.getElementById('snSelect').value;
  const dataList = document.getElementById('dataList');
  if (!sn) {
    latestRows = [];
    dataList.innerHTML = '<p>请选择设备</p>'; showAlert("", false); return;
  }
  if(isFetching) return; isFetching = true;
  try {
    dataList.innerHTML = '<em>加载中...</em>';
    const res = await fetch(`/api/latest?sn=${encodeURIComponent(sn)}`);
    const data = await res.json();
    latestRows = data;
    renderTable();
  } catch (e) {
    showAlert("获取数据失败", true);
  } finally { isFetching = false; }
}

// 渲染/刷新表格，只显示最新10条
function renderTable() {
  if (!latestRows || !latestRows.length) {
    document.getElementById('dataList').innerHTML = '<p>无数据</p>'; showAlert("", false); return;
  }
  let html = `<table><thead><tr>
    <th>SN</th><th>距离(cm)</th><th>电量(%)</th><th>温度(°C)</th><th>位置</th><th>时间</th>
    </tr></thead><tbody>`;
  let dangerExist = false;
  latestRows.slice(0, 10).forEach(r => {
    const danger = threshold !== null && r.distance < threshold;
    if (danger) dangerExist = true;
    html += `<tr${danger ? ' class="danger-row"' : ''}>
      <td>${r.sn}</td>
      <td>${r.distance}</td>
      <td>${r.battery}</td>
      <td>${r.temperature}</td>
      <td>${r.position}</td>
      <td>${formatSgt(r.timestamp)}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('dataList').innerHTML = html;

  if (threshold !== null && dangerExist) {
    showAlert("⚠️ 有距离小于你设置的阈值 " + threshold + "cm，请警惕！", true);
    document.getElementById('dataList').scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else { showAlert("", false); }
}

// 手动上传数据
async function sendData() {
  const btn = event.target; btn.disabled = true; btn.textContent = '上传中...';
  const sn = document.getElementById('snInput').value.trim();
  const distance = parseFloat(document.getElementById('distanceInput').value);
  const battery = parseInt(document.getElementById('batteryInput').value);
  const temperature = parseFloat(document.getElementById('tempInput').value);
  const position = document.getElementById('positionInput').value.trim();

  if (!sn || isNaN(distance) || isNaN(battery) || isNaN(temperature) || !position) {
    showAlert("请填全所有字段"); btn.disabled = false; btn.textContent = '手动上传'; return;
  }
  try {
    const payload = { sn, data: [{ distance, battery, temperature, position }] };
    const res = await fetch('/api/data', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    const text = await res.text();
    showAlert(text);
    // 成功后清空
    document.getElementById('distanceInput').value = '';
    document.getElementById('batteryInput').value = '';
    document.getElementById('tempInput').value = '';
    document.getElementById('positionInput').value = '';
    // 如果刚好本sn在选中，刷新
    const selectedSn = document.getElementById('snSelect').value;
    if (selectedSn === sn) debounceFetchData(400);
  } catch (e) {
    showAlert("上传失败", true);
  } finally { btn.disabled = false; btn.textContent = '手动上传'; }
}

// 新增设备
async function addDevice() {
  const newSn = document.getElementById('newSnInput').value.trim();
  if (!newSn) {
    showAlert("请输入SN");
    return;
  }
  try {
    const res = await fetch('/api/add-sn', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sn: newSn })
    });
    const text = await res.text();
    showAlert(text);
    loadSnList();
  } catch(e) {
    showAlert("添加设备失败", true);
  }
}

// 阈值设置
function setThreshold() {
  const val = parseFloat(document.getElementById('thresholdInput').value);
  if (isNaN(val) || val <= 0) { showAlert('请输入正确的距离阈值'); return; }
  threshold = val;
  renderTable();
}

// 导出CSV
function exportCSV() {
  window.location.href = "/api/export-csv";
}

// WebSocket实时推送
function setupWebSocket() {
  const ws = new WebSocket(`ws://${location.host}`);
  ws.onopen = () => { showAlert('实时推送已连接'); };
  ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }
    if (!data.sn) return;
    const selectedSn = document.getElementById('snSelect').value;
    // 只推当前选中sn的数据，否则忽略
    if (selectedSn && data.sn === selectedSn) {
      latestRows.unshift(data);
      // 去重
      const seen = new Set();
      latestRows = latestRows.filter(row => {
        let k = row.sn + '|' + row.timestamp;
        if (seen.has(k)) return false;
        seen.add(k); return true;
      }).slice(0, 10);
      renderTable();
    }
  };
  ws.onclose = () => {
    showAlert('实时推送断开，重连中...');
    setTimeout(setupWebSocket, 2000);
  };
  ws.onerror = () => ws.close();
}

// 页面初始化
window.onload = function() {
  loadSnList();
  // 如需实时WebSocket功能，取消下一行注释
  setupWebSocket();
  // 如需自动定时刷新, 可取消下行注释
  setInterval(fetchData, 10000); // 每10秒自动刷新
}
</script>