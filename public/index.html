<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Bin Sensor Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 8px; }
    table { border-collapse: collapse; width: 100%; max-width: 1000px; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    #alertMsg { color: red; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ å‘é€æ•°æ®</h2>
  <input id="snInput" placeholder="è®¾å¤‡ SN" />
  <input id="distanceInput" placeholder="è·ç¦» (cm)" />
  <input id="batteryInput" placeholder="ç”µé‡ (%)" />
  <input id="tempInput" placeholder="æ¸©åº¦ (Â°C)" />
  <input id="positionInput" placeholder="å§¿æ€ï¼ˆå¦‚ tiltï¼‰" />
  <button onclick="sendData()">å‘é€æ•°æ®</button>

  <h3>ğŸ“ˆ æ•°æ®æ˜¾ç¤ºä¸å¯¼å‡º</h3>
  <div>
    <label for="addSnInput">æ·»åŠ æ–°è®¾å¤‡ SN:</label>
    <input id="addSnInput" placeholder="è¾“å…¥æ–°è®¾å¤‡ SN" />
    <button onclick="addSn()">æ·»åŠ  SN</button>
  </div>
  <br/>
  <label for="snSelect">é€‰æ‹©è®¾å¤‡ SN:</label>
  <select id="snSelect" onchange="onSnChange()">
    <option value="">è¯·é€‰æ‹©è®¾å¤‡ SN</option>
  </select>

  <input id="thresholdInput" placeholder="é˜ˆå€¼è·ç¦» (cm)" />
  <button onclick="setThreshold()">è®¾ç½®é˜ˆå€¼</button>
  <button onclick="fetchData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
  <button onclick="exportCSV()">â¬‡ï¸ å¯¼å‡º CSV</button>
  <div id="alertMsg"></div>

  <div id="dataList"></div>

  <script>
    let threshold = null;

    function formatSGT(datetimeStr) {
      const date = new Date(datetimeStr);
      return new Intl.DateTimeFormat('zh-SG', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Singapore'
      }).format(date);
    }

    async function loadSnList() {
      const res = await fetch('/api/all-sns');
      const sns = await res.json();
      const select = document.getElementById('snSelect');
      // æ¸…ç©ºä¹‹å‰é€‰é¡¹ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªâ€œè¯·é€‰æ‹©è®¾å¤‡ SNâ€
      select.options.length = 1;
      sns.forEach(sn => {
        const option = document.createElement('option');
        option.value = sn;
        option.textContent = sn;
        select.appendChild(option);
      });
    }

    function addSn() {
      const newSn = document.getElementById('addSnInput').value.trim();
      if (!newSn) {
        alert("è¯·è¾“å…¥è®¾å¤‡ SN");
        return;
      }
      const select = document.getElementById('snSelect');
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === newSn) {
          alert("è®¾å¤‡ SN å·²å­˜åœ¨");
          select.value = newSn;
          onSnChange();
          return;
        }
      }
      const option = document.createElement('option');
      option.value = newSn;
      option.textContent = newSn;
      select.appendChild(option);
      select.value = newSn;
      onSnChange();
      document.getElementById('addSnInput').value = '';
    }

    function onSnChange() {
      fetchData();
    }

    async function fetchData() {
      const selectedSn = document.getElementById('snSelect').value;
      if (!selectedSn) {
        document.getElementById('dataList').innerHTML = '<p>è¯·å…ˆé€‰æ‹©è®¾å¤‡ SN</p>';
        document.getElementById('alertMsg').textContent = '';
        return;
      }

      const res = await fetch(`/api/latest?sn=${encodeURIComponent(selectedSn)}`);
      const data = await res.json();

      if (!data.length) {
        document.getElementById('dataList').innerHTML = '<p>æ— æ•°æ®</p>';
        document.getElementById('alertMsg').textContent = '';
        return;
      }

      let html = `<table><thead><tr>
        <th>SN</th><th>è·ç¦» (cm)</th><th>ç”µé‡ (%)</th><th>æ¸©åº¦ (Â°C)</th><th>å§¿æ€</th><th>æ—¶é—´</th>
      </tr></thead><tbody>`;

      let thresholdAlert = false;
      data.forEach(entry => {
        const danger = threshold !== null && entry.distance < threshold;
        if (danger) thresholdAlert = true;
        html += `<tr>
          <td>${entry.robot_SN}</td>
          <td style="background:${danger ? '#ffcccc' : 'transparent'}">${entry.distance}</td>
          <td>${entry.battery}</td>
          <td>${entry.temperature}</td>
          <td>${entry.position}</td>
          <td>${formatSGT(entry.timestamp)}</td>
        </tr>`;
      });
      html += '</tbody></table>';

      document.getElementById('dataList').innerHTML = html;
      document.getElementById('alertMsg').textContent = thresholdAlert
        ? `âš ï¸ æœ‰è·ç¦»ä½äºé˜ˆå€¼ ${threshold} cmï¼`
        : '';
    }

    async function sendData() {
      const sn = document.getElementById('snInput').value.trim();
      const distance = parseFloat(document.getElementById('distanceInput').value);
      const battery = parseInt(document.getElementById('batteryInput').value);
      const temperature = parseFloat(document.getElementById('tempInput').value);
      const position = document.getElementById('positionInput').value.trim();

      if (!sn || isNaN(distance) || isNaN(battery) || isNaN(temperature) || !position) {
        alert("è¯·è¾“å…¥æ‰€æœ‰å­—æ®µçš„æœ‰æ•ˆå€¼ï¼");
        return;
      }

      const payload = {
        sn,
        data: [{ distance, battery, temperature, position }]
      };

      const res = await fetch('/api/data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      alert(text);

      // å‘é€åå¦‚æœé€‰ä¸­äº†è¿™ä¸ªsnï¼Œåˆ™åˆ·æ–°æ•°æ®
      const selectedSn = document.getElementById('snSelect').value;
      if (selectedSn === sn) {
        fetchData();
      } else {
        // æ²¡é€‰ä¸­è¯¥ SNï¼Œå¯é€‰æ‹©è‡ªåŠ¨æ·»åŠ åˆ°ä¸‹æ‹‰
        // addSn() ä¹Ÿå¯è°ƒç”¨ï¼Œè¿™é‡Œé»˜è®¤ä¸è‡ªåŠ¨åŠ 
      }
    }

    function setThreshold() {
      const val = parseFloat(document.getElementById('thresholdInput').value);
      if (isNaN(val) || val <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é˜ˆå€¼è·ç¦»");
        return;
      }
      threshold = val;
      fetchData();
    }

    function exportCSV() {
      window.location.href = "/api/export-csv";
    }

    window.onload = () => {
      loadSnList();
      setInterval(fetchData, 30000); // æ¯30ç§’åˆ·æ–°
    };
  </script>
</body>
</html>
