<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bin Sensor 控制台</title>
  <style>
    :root {
      --primary: #2563eb;
      --danger: #dc2626;
      --bg: #f4f6fb;
      --card: #ffffff;
      --radius: 10px;
      --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      --muted: #475569;
      --border: #e2e8f0;
      --success: #16a34a;
      color-scheme: light;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: #0f172a;
      line-height: 1.6;
    }

    header {
      padding: 28px 20px;
      background: var(--card);
      box-shadow: var(--shadow);
    }

    header h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 2px;
    }

    header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 15px;
    }

    main {
      padding: 24px 20px 60px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      gap: 20px;
    }

    @media (min-width: 960px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.12);
    }

    .card h2 {
      margin: 0 0 16px;
      font-size: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1e293b;
    }

    input, select, button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    button {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      border: none;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 600px) {
      .actions {
        flex-direction: row;
      }

      .actions > * {
        flex: 1;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      text-align: left;
      white-space: nowrap;
    }

    th {
      text-transform: uppercase;
      font-weight: 600;
      font-size: 12px;
      color: #475569;
      letter-spacing: 1px;
      background: rgba(37, 99, 235, 0.06);
    }

    tr.highlight {
      background: rgba(220, 38, 38, 0.08);
      color: #b91c1c;
    }

    .banner {
      margin-bottom: 18px;
      padding: 12px 14px;
      border-radius: 8px;
      display: none;
      font-weight: 600;
    }

    .banner.show {
      display: block;
    }

    .banner.success {
      background: rgba(22, 163, 74, 0.1);
      color: var(--success);
    }

    .banner.error {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <header>
    <h1>BIN SENSOR SERVER</h1>
    <p>EM400-MUD → MQTT → Web 数据链路监控，支持幂等入库与安全策略。</p>
  </header>

  <main>
    <div id="banner" class="banner"></div>

    <div class="grid">
      <section class="card">
        <h2>注册设备 SN</h2>
        <label for="new-sn">设备序列号 (sn)</label>
        <input id="new-sn" placeholder="例如：mud-30123456">
        <button id="register-btn">注册设备</button>
      </section>

      <section class="card">
        <h2>手动采集上报</h2>
        <div>
          <label for="manual-sn">设备 SN</label>
          <input id="manual-sn" placeholder="请输入已注册 SN">
        </div>
        <div>
          <label for="manual-distance">距离 (cm)</label>
          <input id="manual-distance" type="number" min="0" step="0.1">
        </div>
        <div>
          <label for="manual-battery">电量 (%)</label>
          <input id="manual-battery" type="number" min="0" max="100" step="1">
        </div>
        <div>
          <label for="manual-temperature">温度 (℃)</label>
          <input id="manual-temperature" type="number" min="-40" max="85" step="0.1">
        </div>
        <div>
          <label for="manual-position">姿态</label>
          <input id="manual-position" placeholder="normal / tilt">
        </div>
        <div class="actions">
          <button id="manual-submit">立即上报</button>
          <button id="export-btn">导出最近 10,000 条 CSV</button>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top: 20px;">
      <h2>实时数据</h2>
      <div class="actions">
        <select id="sn-filter">
          <option value="">全部设备</option>
        </select>
        <button id="refresh-btn">刷新列表</button>
      </div>
      <table id="data-table">
        <thead>
          <tr>
            <th>SN</th>
            <th>距离(cm)</th>
            <th>距离(mm)</th>
            <th>温度(℃)</th>
            <th>电量(%)</th>
            <th>姿态</th>
            <th>温度告警</th>
            <th>距离告警</th>
            <th>时间戳</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    const banner = document.getElementById('banner');
    const registerBtn = document.getElementById('register-btn');
    const manualSubmitBtn = document.getElementById('manual-submit');
    const refreshBtn = document.getElementById('refresh-btn');
    const exportBtn = document.getElementById('export-btn');
    const snFilter = document.getElementById('sn-filter');
    const tableBody = document.querySelector('#data-table tbody');
    const records = [];

    function showBanner(message, type = 'success') {
      banner.textContent = message;
      banner.className = `banner show ${type}`;
      setTimeout(() => {
        banner.className = 'banner';
      }, 4000);
    }

    async function registerDevice() {
      const sn = document.getElementById('new-sn').value.trim();
      if (!sn) {
        showBanner('请填写 SN', 'error');
        return;
      }
      registerBtn.disabled = true;
      try {
        const res = await fetch('/api/add-sn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sn }),
        });
        const data = await res.json();
        if (res.ok) {
          showBanner(`设备 ${sn} 注册成功`);
          document.getElementById('manual-sn').value = sn;
          await loadDeviceOptions();
        } else {
          showBanner(data.message || '注册失败', 'error');
        }
      } catch (err) {
        showBanner(err.message, 'error');
      } finally {
        registerBtn.disabled = false;
      }
    }

    async function submitManual() {
      const payload = {
        sn: document.getElementById('manual-sn').value.trim(),
        sensor: {
          distance_cm: parseFloat(document.getElementById('manual-distance').value),
          battery: parseInt(document.getElementById('manual-battery').value, 10),
          temperature_c: parseFloat(document.getElementById('manual-temperature').value),
          position: document.getElementById('manual-position').value.trim() || undefined,
        },
      };
      if (!payload.sn) {
        showBanner('请填写已注册的 SN', 'error');
        return;
      }
      manualSubmitBtn.disabled = true;
      try {
        const res = await fetch('/api/data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) {
          showBanner(data.message || '上报失败', 'error');
          return;
        }
        showBanner('上报成功');
        await refreshTable();
      } catch (err) {
        showBanner(err.message, 'error');
      } finally {
        manualSubmitBtn.disabled = false;
      }
    }

    async function loadDeviceOptions() {
      const res = await fetch('/api/all-sns?limit=200');
      const data = await res.json();
      if (!res.ok) return;
      const options = ['<option value="">全部设备</option>'];
      (data.data?.devices || []).forEach(({ sn }) => {
        options.push(`<option value="${sn}">${sn}</option>`);
      });
      snFilter.innerHTML = options.join('');
    }

    function renderTable() {
      const rows = records.slice(0, 50).map((row) => {
        const highlight = row.temperature_alarm === 1 || row.distance_alarm === 1;
        return `
          <tr class="${highlight ? 'highlight' : ''}">
            <td>${row.sn}</td>
            <td>${row.distance_cm ?? ''}</td>
            <td>${row.distance_mm ?? ''}</td>
            <td>${row.temperature_c ?? ''}</td>
            <td>${row.battery ?? ''}</td>
            <td>${row.position ?? ''}</td>
            <td>${row.temperature_alarm ?? 0}</td>
            <td>${row.distance_alarm ?? 0}</td>
            <td>${new Date(row.ts).toLocaleString()}</td>
          </tr>
        `;
      });
      tableBody.innerHTML = rows.join('');
    }

    async function refreshTable() {
      const params = new URLSearchParams({ limit: 50 });
      if (snFilter.value) params.append('sn', snFilter.value);
      const res = await fetch(`/api/latest?${params.toString()}`);
      const data = await res.json();
      if (!res.ok) {
        showBanner(data.message || '查询失败', 'error');
        return;
      }
      records.length = 0;
      (data.data?.data || []).forEach((row) => records.push(row));
      renderTable();
    }

    function setupWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${protocol}://${window.location.host}`);
      ws.onopen = () => showBanner('实时通道已建立');
      ws.onmessage = (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (!payload.sn) return;
          if (snFilter.value && payload.sn !== snFilter.value) return;
          records.unshift(payload);
          const seen = new Set();
          const filtered = [];
          for (const row of records) {
            const key = `${row.sn}|${row.ts}`;
            if (seen.has(key)) continue;
            seen.add(key);
            filtered.push(row);
            if (filtered.length >= 50) break;
          }
          records.length = 0;
          records.push(...filtered);
          renderTable();
        } catch (_) {
          /* ignore */
        }
      };
      ws.onclose = () => {
        showBanner('WebSocket 已断开，尝试重连...', 'error');
        setTimeout(setupWebSocket, 3000);
      };
      ws.onerror = () => ws.close();
    }

    registerBtn.addEventListener('click', registerDevice);
    manualSubmitBtn.addEventListener('click', submitManual);
    refreshBtn.addEventListener('click', refreshTable);
    snFilter.addEventListener('change', refreshTable);
    exportBtn.addEventListener('click', () => {
      window.location.href = '/api/export-csv';
    });

    (async function bootstrap() {
      await loadDeviceOptions();
      await refreshTable();
      setupWebSocket();
    })();
  </script>
</body>
</html>
